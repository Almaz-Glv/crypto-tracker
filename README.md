# Crypto Tracker

## Описание проекта

**Crypto Tracker** — backend‑приложение для автоматического получения, хранения и предоставления исторических данных о ценах криптовалют (BTC, ETH) с использованием публичного API биржи **Deribit**.

Проект реализован на **FastAPI** и построен по принципам **Clean Architecture**, что обеспечивает чёткое разделение ответственности между слоями, высокую тестируемость и удобство масштабирования.

Решение ориентировано на демонстрацию архитектурных навыков backend‑разработки и может использоваться как основа для систем мониторинга, аналитики или трейдинговых сервисов.

---

## Функциональные возможности

* Автоматическое получение цен BTC и ETH с Deribit API
* Асинхронная загрузка данных с сохранением в PostgreSQL
* Планировщик фоновых задач (Celery + Redis)
* REST API для получения:

  * последней цены
  * истории цен
  * данных за выбранный период
* Валидация входных данных (Pydantic)
* Миграции базы данных (Alembic)
* Unit и Integration тестирование
* Docker‑окружение для локального и production‑запуска

---

## Архитектура

Проект реализован с использованием **Clean Architecture** с логическим разделением на слои:

* **API** — HTTP‑интерфейс (FastAPI, роутеры)
* **Application** — прикладная логика и сервисы
* **Domain** — бизнес‑модели и схемы данных
* **Infrastructure** — работа с БД, внешними API и брокерами сообщений

Зависимости направлены строго внутрь: внешние слои не влияют на доменную логику.

---

## Структура проекта

```
crypto-tracker/
├── alembic/                    # Миграции БД
├── src/
│   ├── api/                    # HTTP слой (FastAPI)
│   │   ├── routers/            # API эндпоинты
│   │   └── dependencies.py     # Dependency Injection
│   │
│   ├── application/            # Сервисы и Celery задачи
│   │   ├── services.py
│   │   └── tasks.py
│   │
│   ├── core/                   # Конфигурация приложения
│   │   └── config.py
│   │
│   ├── domain/                 # Доменные модели и схемы
│   │   ├── models.py
│   │   └── schemas.py
│   │
│   └── infrastructure/         # Инфраструктурный слой
│       ├── database.py         # PostgreSQL + SQLAlchemy
│       ├── repositories.py     # Репозитории
│       ├── deribit_client.py   # Клиент Deribit API
│       └── celery_app.py       # Celery конфигурация
│
├── tests/
│   ├── unit/
│   └── integration/
│
├── main.py                     # Точка входа приложения
├── Dockerfile
├── docker-compose.yml
├── requirements.txt
└── README.md
```

---

## Основные компоненты

### PriceService

`PriceService` является центральным сервисом приложения:

* асинхронно получает цены BTC и ETH
* сохраняет данные в БД через репозиторий
* предоставляет методы для API (последняя цена, история, диапазон дат)
* содержит синхронную обёртку для выполнения в Celery

### DeribitClient

Асинхронный HTTP‑клиент на базе `aiohttp`, отвечающий за взаимодействие с Deribit API:

* получение текущей индексной цены
* обработка ошибок и таймаутов
* единая HTTP‑сессия

### PriceRepository

Инкапсулирует всю работу с базой данных:

* создание записей цен
* получение последней цены
* выборка истории и диапазонов дат
* защита от дублирования записей по timestamp

---

## API

### Базовые эндпоинты

| Метод | URL              | Описание               |
| ----- | ---------------- | ---------------------- |
| GET   | `/prices/all`    | История цен по тикеру  |
| GET   | `/prices/last`   | Последняя цена         |
| GET   | `/prices/filter` | Цены за период         |
| GET   | `/fetch-prices`  | Ручной запуск загрузки |
| GET   | `/health`        | Проверка состояния     |

### Примеры запросов

```
/prices/all?ticker=btc_usd&limit=10
/prices/last?ticker=eth_usd
/prices/filter?ticker=btc_usd&date_from=1705618800&date_to=1705705200
```

Swagger документация доступна по адресу:

```
/api/docs
```

---

## Фоновые задачи (Celery)

Используется **Celery + Redis** для периодического сбора цен.

* Задача `fetch_and_store_prices_task`
* Запускается каждую минуту (Celery Beat)
* Поддерживает retry при ошибках
* Использует синхронный вызов сервиса

---

## Конфигурация

Настройки задаются через `.env` файл и `pydantic-settings`:

* PostgreSQL
* Redis
* Deribit API
* параметры приложения и логирования

---

## Запуск проекта

### Docker (рекомендуется)

```
docker-compose up --build
```

API будет доступно по адресу:

```
http://localhost:8000
```

---

### Локальный запуск

```
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
alembic upgrade head
python main.py
```

---

## Тестирование

```
pytest tests/unit
pytest tests/integration
```

---

## Используемые технологии

* Python 3.10+
* FastAPI
* SQLAlchemy
* PostgreSQL
* Alembic
* Celery
* Redis
* Docker
* Pytest

---

## Назначение проекта

Проект разработан с целью:

* демонстрации архитектурных подходов backend‑разработки
* практики работы с асинхронностью
* интеграции внешних API
* построения масштабируемых сервисов


